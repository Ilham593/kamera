<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Cinematic One-Tap</title>
<style>
  html,body{margin:0;height:100%;background:#000;color:#fff;font-family:system-ui,Arial}
  .app{display:flex;flex-direction:column;min-height:100vh}
  .stage{position:relative;flex:1;display:flex;align-items:center;justify-content:center;background:#000;overflow:hidden}
  canvas{max-width:100%;max-height:100%;touch-action:none}
  video{display:none}
  .bar{display:flex;gap:10px;align-items:center;justify-content:center;padding:12px;border-top:1px solid #1d1d1d;background:#0b0b0b}
  button{background:#22c55e;color:#062;border:0;padding:12px 18px;border-radius:999px;font-weight:800;font-size:16px}
  .hint{font-size:12px;opacity:.85}
</style>
</head>
<body>
<div class="app">
  <div class="stage">
    <canvas id="c"></canvas>
    <video id="v" autoplay playsinline></video>
  </div>
  <div class="bar">
    <button id="shot">ðŸ“¸ JEPRET</button>
    <span class="hint">Otomatis: grading + vignette + grain + crop 2.39:1</span>
  </div>
</div>

<script>
(async ()=>{
  const v = document.getElementById('v');
  const c = document.getElementById('c');
  const ctx = c.getContext('2d', {willReadFrequently:true});
  const btn = document.getElementById('shot');

  // ====== Start camera (prefer kamera belakang) ======
  async function startCam(){
    // constraint ringan biar lancar di HP; bisa dinaikkan nanti
    const constraints = {
      video: {
        facingMode: { ideal: "environment" },
        width: { ideal: 1280 }, height: { ideal: 720 }
      },
      audio: false
    };
    const stream = await navigator.mediaDevices.getUserMedia(constraints);
    v.srcObject = stream;
    await v.play();
    requestAnimationFrame(loop);
  }

  // ====== Grading sinematik (teal-orange sederhana + contrast + grain + vignette) ======
  function cinematicPass(img){
    const d = img.data, L = d.length;

    // Kontras ringan
    const contrast = 1.15;
    const factor = (259*(contrast*128 - 128))/(255*(259 - (contrast*128 - 128)));

    // Tealâ€“orange sederhana + kontras
    for (let i=0;i<L;i+=4){
      let r=d[i], g=d[i+1], b=d[i+2];
      const l = 0.2126*r + 0.7152*g + 0.0722*b; // luma
      if (l < 100) { r*=0.92; g*=0.96; b*=1.05; } // shadows -> teal-ish
      else         { r*=1.05; g*=1.02; b*=0.98; } // highlights -> warm
      r = factor*(r-128)+128; g = factor*(g-128)+128; b = factor*(b-128)+128;
      d[i]  = r<0?0:(r>255?255:r);
      d[i+1]= g<0?0:(g>255?255:g);
      d[i+2]= b<0?0:(b>255?255:b);
    }

    // Grain tipis
    const grain = 0.08;
    for (let i=0;i<L;i+=4){
      const n = (Math.random()-0.5)*255*grain;
      d[i]  = Math.max(0, Math.min(255, d[i]  + n));
      d[i+1]= Math.max(0, Math.min(255, d[i+1]+ n));
      d[i+2]= Math.max(0, Math.min(255, d[i+2]+ n));
    }

    // Vignette
    const w = img.width, h = img.height;
    const cx = w/2, cy = h/2;
    const maxR = Math.hypot(cx, cy);
    const vig = 0.42;
    for (let y=0;y<h;y++){
      for (let x=0;x<w;x++){
        const dist = Math.hypot(x-cx, y-cy)/maxR;
        const dark = Math.pow(dist, 2.2) * vig;
        const idx = (y*w + x)*4;
        d[idx]   *= (1-dark);
        d[idx+1] *= (1-dark);
        d[idx+2] *= (1-dark);
      }
    }
    return img;
  }

  // ====== Render loop (preview realtime dengan letterbox) ======
  function loop(){
    const vw = v.videoWidth, vh = v.videoHeight;
    if (!vw || !vh) return requestAnimationFrame(loop);

    // Skala aman buat HP
    const maxW = 1280;
    let W = vw, H = vh;
    if (vw > maxW){ const s = maxW / vw; W = Math.round(vw*s); H = Math.round(vh*s); }

    c.width = W; c.height = H;
    ctx.drawImage(v, 0, 0, W, H);

    let img = ctx.getImageData(0,0,W,H);
    img = cinematicPass(img);
    ctx.putImageData(img, 0, 0);

    // Letterbox (preview saja)
    const tgtH = Math.round(W/2.39);
    const bar = Math.max(0, Math.round((H - tgtH)/2));
    if (bar > 0){
      ctx.fillStyle = 'black';
      ctx.fillRect(0, 0, W, bar);
      ctx.fillRect(0, H-bar, W, bar);
    }

    requestAnimationFrame(loop);
  }

  // ====== Capture (crop 2.39:1 tengah + simpan JPG) ======
  function snap(){
    const W = c.width, H = c.height;
    const tgtH = Math.round(W/2.39);
    const bar = Math.max(0, Math.round((H - tgtH)/2));

    const out = document.createElement('canvas');
    out.width = W; out.height = tgtH;
    const octx = out.getContext('2d');
    octx.drawImage(c, 0, bar, W, tgtH, 0, 0, W, tgtH);

    out.toBlob(b=>{
      const a = document.createElement('a');
      a.href = URL.createObjectURL(b);
      a.download = `cinematic_${Date.now()}.jpg`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(a.href);
    }, 'image/jpeg', 0.92);
  }

  btn.addEventListener('click', snap);

  try {
    await startCam();
  } catch (e){
    alert('Gagal akses kamera: ' + e.message + '\nTip: buka via HTTPS atau localhost.');
  }
})();
</script>
</body>
</html>
